#!/bin/bash

#SBATCH --job-name=parsl.auto.1592855689.09553
#SBATCH --output=/home/aymen/parsl_scripts/parsl.auto.1592855689.09553.submit.stdout
#SBATCH --error=/home/aymen/parsl_scripts/parsl.auto.1592855689.09553.submit.stderr
#SBATCH --nodes=72
#SBATCH --partition=compute
#SBATCH --time=30
#SBATCH --ntasks-per-node=1
#SBATCH --exclusive


source /home/aymen/ve/parsl-env/bin/activate

export JOBNAME="parsl.auto.1592855689.09553"

export CORES=$SLURM_CPUS_ON_NODE
export NODES=$SLURM_JOB_NUM_NODES

echo "Found cores : $CORES"
echo "Found nodes : $NODES"
WORKERCOUNT=72

cat << SLURM_EOF > cmd_$SLURM_JOB_NAME.sh
process_worker_pool.py --debug --max_workers=1728 -p 0 -c 1 -m None --poll 10 --task_url=tcp://comet-ln2.sdsc.edu:50548 --result_url=tcp://comet-ln2.sdsc.edu:50877 --logdir=/home/aymen/parsl_scripts/Comet_HTEX_multinode --block_id=0 --hb_period=30 --hb_threshold=120 
SLURM_EOF
chmod a+x cmd_$SLURM_JOB_NAME.sh

TASKBLOCKS=72

srun --ntasks $TASKBLOCKS -l  bash cmd_$SLURM_JOB_NAME.sh

echo "Done"

